strategy:
  matrix:
    linux:
      imageName: 'ubuntu-16.04'
      rid: "linux-x64"
    mac:
      imageName: 'macos-10.13'
      rid: "osx-x64"
    windows:
      imageName: 'vs2017-win2016'
      rid: "win-x64"

pool:
  vmImage: $(imageName)

steps:
  - task: DotNetCoreCLI@2
    name: "restore solution"
    inputs:
      command: 'restore'
      projects: "dotnet-encoding.sln"
  - task: DotNetCoreCLI@2
    name: "build solution"
    inputs:
      command: "build"
      configuration: "release"
      projects: "dotnet-encoding.sln"
  - task: DotNetCoreCLI@2
    name: "test solution"
    inputs:
      command: "test"
      configuration: "Release"
      projects: "dotnet-encoding.sln"
  - task: DotNetCoreCLI@2
    name: "pack solution"
    inputs:
      command: "pack"
      configuration: "release"
      packagesToPack: "dotnet-text-encoder/dotnet-text-encoder.csproj"
  - task: DotNetCoreCLI@2
    name: "publish project as single file binary"
    inputs:
      command: "publish"
      configuration: "release"
      buildProperties: "WithCoreRT=true;RuntimeIdentifier=$(rid)"
      projects: "dotnet-text-encoder/dotnet-text-encoder.csproj"
  - task: CopyFiles@2
    name: "copying native file"
    inputs:
      sourceFolder: "$(Build.SourceDirectory)/dotnet-text-encoder/bin/Release/netcoreapp2.1/$(rid)/native"
      contents: "*"
  - task: CopyFiles@2
    name: "copying nupkg"
    inputs:
      sourceFolder: "$(Build.SourceDirectory)/dotnet-text-encoder/bin/Release"
      contents: "**/*.nupkg"
  - task: PublishBuildArtifacts@1
    name: "publishing artifacts"
    inputs:
      pathToPublish: "$(Build.ArtifactStagingDirectory)"
      artifactName: "dotnet-tenc-$(rid)"
